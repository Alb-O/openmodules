name: AGENTS.md Audit

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  audit:
    if: contains(github.event.comment.body, '/audit-agents')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run OpenCode Audit
        uses: sst/opencode/github@latest
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
        with:
          model: opencode/big-pickle
          prompt: |
            Ultrathink: Audit the AGENTS.md file against the current codebase. Verify that documentation is accurate and reflects the actual implementation. Do NOT suggest adding new content; the goal is verification, not expansion.

            Read AGENTS.md and extract factual claims about the codebase (function names, file paths, behaviors, patterns). Verify each claim by reading the referenced source files. Check for stale references: renamed functions, moved files, changed APIs, removed features.

            For code style claims, treat them as preferences with pragmatic exceptions rather than absolute rules. A few instances of `else` or `try`/`catch` in a codebase that prefers early returns is not a violation worth flagging. Only flag style claims if they're fundamentally misleading about the codebase's actual conventions.

            Create a GitHub comment summarizing your findings. Use prose to explain what you found and why it matters. Lists are appropriate for enumerating specific issues or verified claims, but wrap them in context. Lead with the status and most important findings.

            Status levels: PASS if accurate, WARN for minor inaccuracies that could confuse readers, FAIL for claims that are wrong in ways that would mislead someone following the documentation.

            Include file paths and line numbers when citing issues. For corrections, be specific about what's wrong and what the fix should be. Skip suggestions for expanding coverage or adding new documentation.
